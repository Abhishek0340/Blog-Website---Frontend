import React, { useState, useRef, useEffect } from 'react';
import { Helmet } from "react-helmet";
import { useLocation, useNavigate } from 'react-router-dom';
import DashboardLayout from './DashboardLayout';
import JoditEditor from "jodit-react";

const initialState = {
  blogName: '',
  subtitle: '',
  description: '',
  keywords: '',
  authorName: '',
  authorGmail: '',
  category: '',
  date: '',
  thumbnail: '',
  images: [],
};

const categories = ['Nature', 'Travel', 'Science', 'Technology', 'Finance'];

const Post = () => {
  const [form, setForm] = useState(initialState);
  const [thumbFile, setThumbFile] = useState(null);
  const [imageFiles, setImageFiles] = useState([]);
  const [isEditing, setIsEditing] = useState(false);
  const [editPostId, setEditPostId] = useState(null);
  const editorRef = useRef(null);
  const location = useLocation();
  const navigate = useNavigate();

  useEffect(() => {
    const email = localStorage.getItem('authEmail');
    const today = new Date().toISOString().split('T')[0];

    if (email) {
      fetch(`http://localhost:5000/api/userinfo?email=${email}`)
        .then(res => res.json())
        .then(data => {
          if (!data.error && !(location.state && location.state.editPost)) {
            setForm(prev => ({
              ...prev,
              authorName: data.username || '',
              authorGmail: data.email || email,
              date: today
            }));
          }
        })
        .catch(err => console.error("Error fetching user info:", err));
    }

    if (location.state && location.state.editPost) {
      const post = location.state.editPost;
      setIsEditing(true);
      setEditPostId(post._id);

      setForm({
        blogName: post.title || '',
        subtitle: post.subtitle || '',
        description: post.content || '',
        keywords: post.keywords || '',
        authorName: post.author || '',
        authorGmail: post.authorGmail || email || '',
        category: post.category || '',
        date: post.createdAt ? new Date(post.createdAt).toISOString().split('T')[0] : today,
        thumbnail: post.thumbnail || '',
        images: post.images || [],
      });
    }
  }, [location.state]);

  const handleChange = e => {
    const { name, value } = e.target;
    setForm(prev => ({ ...prev, [name]: value }));
  };

  const handleEditorChange = newContent => {
    const words = newContent.replace(/<[^>]+>/g, '')
      .split(/\s+/)
      .filter(w => w.length > 3)
      .slice(0, 20);

    setForm(prev => ({
      ...prev,
      description: newContent,
      keywords: prev.keywords || words.join(', ')
    }));
  };

  const handleThumbChange = e => {
    const file = e.target.files[0];
    setThumbFile(file);
    setForm(prev => ({ ...prev, thumbnail: file ? URL.createObjectURL(file) : '' }));
  };

  const handleImagesChange = e => {
    const files = Array.from(e.target.files);
    setImageFiles(files);
    setForm(prev => ({
      ...prev,
      images: [
        ...files.map(f => URL.createObjectURL(f)),
        ...((prev.imageUrls || '').split(/\n|,/).map(u => u.trim()).filter(Boolean))
      ]
    }));
  };

  const handleImageUrlsChange = e => {
    const value = e.target.value;
    setForm(prev => ({
      ...prev,
      imageUrls: value,
      images: [
        ...imageFiles.map(f => URL.createObjectURL(f)),
        ...value.split(/\n|,/).map(u => u.trim()).filter(Boolean)
      ]
    }));
  };


  const handleSubmit = async e => {
    e.preventDefault();
    const postData = {
      title: form.blogName,
      content: form.description,
      author: form.authorName,
      category: form.category,
      createdAt: form.date,
      thumbnail: form.thumbnail,
      images: form.images,
      keywords: form.keywords,
      subtitle: form.subtitle,
      authorGmail: form.authorGmail,
    };

    try {
      let res;
      if (isEditing) {
        res = await fetch(`http://localhost:5000/api/posts/${editPostId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData),
        });
      } else {
        res = await fetch('http://localhost:5000/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData),
        });
      }

      const data = await res.json();

      if (res.ok) {
        alert(isEditing ? 'Blog updated successfully!' : 'Blog submitted!');
        navigate(isEditing ? '/managepost' : '/');
      } else {
        alert(data.error || "Failed to submit post");
      }
    } catch (err) {
      alert("Error connecting to backend");
    }
  };

  const handleCancel = () => {
    if (isEditing) navigate('/managepost');
    else setForm(initialState);
  };

  return (
    <>
      <Helmet>
        <title>{isEditing ? "Edit Blog Post" : "Create a New Blog Post"} | trendyblogs</title>
        <meta
          name="description"
          content={
            isEditing
              ? "Edit your existing blog post on trendyblogs. Update content, categories, thumbnails, and keywords easily."
              : "Create and publish your own blog on trendyblogs. Add title, subtitle, content, category, images, and more to share your story."
          }
        />
        <meta
          name="keywords"
          content="create blog, edit blog, trendyblogs, write blog, post editor, blogging platform, publish article"
        />
        <meta property="og:title" content={isEditing ? "Edit Blog Post | trendyblogs" : "Create a New Blog Post | trendyblogs"} />
        <meta
          property="og:description"
          content={
            isEditing
              ? "Update your blog post content, images, and metadata on trendyblogs."
              : "Start blogging on trendyblogs â€” create and share your own posts across multiple categories."
          }
        />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://trendyblogs.site/post" />
        <link rel="canonical" href="https://trendyblogs.site/post" />
        <meta name="robots" content="index, follow" />
      </Helmet>

      <DashboardLayout>
        <div className="p-6">
          <h1 className="text-2xl font-bold text-gray-800 mb-6">
            {isEditing ? 'Edit Blog Post' : 'Create a New Blog Post'}
          </h1>
          <div className="w-full max-w-7xl mx-auto rounded border p-4 border-gray-200">
            <form className="flex flex-col gap-6" onSubmit={handleSubmit}>

              {/* Blog Name */}
              <div>
                <label className="block font-semibold mb-2 text-gray-700">Blog Name </label>
                <input
                  type="text"
                  name="blogName"
                  value={form.blogName}
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                  placeholder="Enter blog name..."
                  required
                />
              </div>

              {/* Subtitle */}
              <div>
                <label className="block font-semibold mb-2 text-gray-700">Subtitle</label>
                <input
                  type="text"
                  name="subtitle"
                  value={form.subtitle}
                  onChange={handleChange}
                  placeholder='Enter blog subtitle...'
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                />
              </div>

              {/* Editor */}
              <div>
                <label className="block font-semibold mb-2 text-gray-700">Description</label>
                <JoditEditor
                  ref={editorRef}
                  value={form.description}
                  tabIndex={1}
                  onBlur={handleEditorChange}
                  config={{ height: 300 }}
                />
              </div>

              {/* Keywords */}
              <div>
                <label className="block font-semibold mb-2 text-gray-700">Keywords</label>
                <input
                  type="text"
                  name="keywords"
                  value={form.keywords}
                  onChange={handleChange}
                  placeholder='Enter keywords (comma separated)'
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400"
                />
              </div>

              {/* Author, Category */}
              <div className="block font-semibold mb-2 text-gray-700">
                <div className='hidden'>
                  <label className="block font-semibold mb-2 text-gray-700">Author Name</label>
                  <input
                    type="text"
                    name="authorName"
                    value={form.authorName}
                    readOnly
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
                <div>
                  <label className="block font-semibold mb-2 text-gray-700">Category</label>
                  <select
                    name="category"
                    value={form.category}
                    onChange={handleChange}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                    required
                  >
                    <option value="">Select category</option>
                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </select>
                </div>
              </div>

              {/* Thumbnail */}
              <div>
                <label className="block font-semibold mb-2 text-gray-700">Thumbnail</label>
                <input type="file" accept="image/*" onChange={handleThumbChange} className="mb-2" />
                <input
                  type="url"
                  placeholder="Or paste image URL"
                  value={form.thumbnail}
                  name="thumbnail"
                  onChange={handleChange}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg"
                />
                {form.thumbnail && (
                  <img src={form.thumbnail} alt="Thumbnail" className="mt-2 rounded-lg w-32 h-20 object-cover" />
                )}
              </div>

              {/* Buttons */}
              <div className="flex gap-4">
                <button
                  type="submit"
                  className="px-6 py-2 bg-blue-700 text-white rounded-xl hover:bg-blue-800 font-bold"
                >
                  {isEditing ? 'Update Blog' : 'Submit Blog'}
                </button>
                <button
                  type="button"
                  onClick={handleCancel}
                  className="px-6 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 font-bold"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </DashboardLayout>
    </>
  );
};

export default Post;

import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import DashboardLayout from "./DashboardLayout";
import Spinner from "../components/Spinner";
import { CiEdit } from "react-icons/ci";
import { RiDeleteBin2Line } from "react-icons/ri";
import { Helmet } from "react-helmet";

const ManagePost = () => {
  const [posts, setPosts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const navigate = useNavigate();

  const userEmail = localStorage.getItem("authEmail");
  const isAdmin = localStorage.getItem("isAdmin") === "true";

  useEffect(() => {
    const fetchPosts = async () => {
      setLoading(true);
      setError("");
      try {
        const res = await fetch("http://localhost:5000/api/posts");
        const data = await res.json();

        if (!res.ok) {
          setError(data.error || "Failed to fetch posts.");
          setLoading(false);
          return;
        }

        const filteredPosts = isAdmin
          ? data
          : data.filter((post) => post.authorGmail === userEmail);

        setPosts(filteredPosts);
      } catch (err) {
        setError("Error connecting to backend.");
      } finally {
        setLoading(false);
      }
    };

    fetchPosts();
  }, [userEmail, isAdmin]);

  const handleEdit = (post) => {
    navigate("/post", { state: { editPost: post } });
  };

  const handleDelete = async (id) => {
    if (!window.confirm("Are you sure you want to delete this post?")) return;
    try {
      const res = await fetch(`http://localhost:5000/api/posts/${id}`, {
        method: "DELETE",
      });

      if (res.ok) {
        setPosts(posts.filter((p) => p._id !== id));
      } else {
        const data = await res.json();
        alert(data.error || "Failed to delete post.");
      }
    } catch (err) {
      alert("Error connecting to backend.");
    }
  };

  return (
    <>
      <Helmet>
        <title>{isAdmin ? "Manage All Posts" : "Manage My Posts"} | trendyblogs</title>
        <meta
          name="description"
          content={
            isAdmin
              ? "Admin dashboard to view, edit, or delete all blog posts on trendyblogs."
              : "Manage your blog posts â€” edit, update, or remove your published articles on trendyblogs."
          }
        />
        <meta
          name="keywords"
          content="manage posts, dashboard, edit blogs, delete posts, trendyblogs admin, blog management"
        />
        <meta property="og:title" content="Manage Posts | trendyblogs" />
        <meta
          property="og:description"
          content="Easily manage, edit, or remove your posts on trendyblogs."
        />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://trendyblogs.site/managepost" />
        <link rel="canonical" href="https://trendyblogs.site/managepost" />
        <meta name="robots" content="index, follow" />
      </Helmet>

      <DashboardLayout>
        <div className="p-6 sm:p-6 lg:p-10  min-h-screen">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div className="">
              <h1 className="text-2xl font-bold text-gray-800 mb-6">
                {isAdmin ? "Manage All Blog Posts ðŸ‘‘" : "Manage Your Blog Posts"}
              </h1>
              <p className="text-gray-500 mt-1">
                {isAdmin
                  ? "View, edit, or remove any post from the system."
                  : "Manage your published blog posts below."}
              </p>
            </div>
            <button
              onClick={() => navigate("/post")}
              className="bg-gray-200  font-semibold px-5 py-2.5 rounded-lg hover:from-gray-800 hover:to-gray-600 transition"
            >
              âž• Create New Post
            </button>
          </div>

          {loading ? (
            <div className="flex justify-center text-gray-500 py-20">
              <Spinner />
            </div>
          ) : error ? (
            <div className="text-center text-red-500">{error}</div>
          ) : posts.length === 0 ? (
            <div className="text-center text-gray-500">
              {isAdmin
                ? "No posts found in the system."
                : "No posts found for your account."}
            </div>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              {posts.map((post) => (
                <div
                  key={post._id}
                  className="bg-white/70 backdrop-blur-md border border-gray-200 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 flex flex-col overflow-hidden"
                >
                  {/* Thumbnail */}
                  {post.thumbnail ? (
                    <img
                      src={post.thumbnail}
                      alt={post.title}
                      className="w-full h-48 object-cover rounded-t-2xl"
                    />
                  ) : (
                    <div className="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-500 text-sm">
                      No Image
                    </div>
                  )}

                  <div className="flex flex-col flex-grow p-5">
                    <div className="flex justify-between items-center mb-3">
                      <span className="text-xs bg-indigo-100 text-indigo-700 font-semibold px-2 py-1 rounded-full uppercase tracking-wide">
                        {post.category || "Uncategorized"}
                      </span>
                      <span className="text-xs text-gray-500">
                        {post.createdAt
                          ? new Date(post.createdAt).toLocaleDateString()
                          : ""}
                      </span>
                    </div>

                    <h2 className="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
                      {post.title}
                    </h2>

                    <p className="text-sm text-gray-600 mb-4 line-clamp-3">
                      {post.content.replace(/<[^>]+>/g, "").substring(0, 100)}...
                    </p>

                    {/* Keywords */}
                    {post.keywords && (
                      <div className="flex flex-wrap gap-2 mb-4">
                        {post.keywords
                          .split(",")
                          .slice(0, 3)
                          .map((kw, idx) => (
                            <span
                              key={idx}
                              className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full"
                            >
                              #{kw.trim()}
                            </span>
                          ))}
                      </div>
                    )}

                    {/* Author info for admin */}
                    {isAdmin && (
                      <div className="text-xs text-gray-500 mb-3">
                        Author:{" "}
                        <span className="font-medium text-gray-700">
                          {post.authorGmail || "Unknown"}
                        </span>
                      </div>
                    )}

                    {/* Action Buttons */}
                    <div className="flex justify-between items-center mt-auto border-t border-gray-100 pt-3">
                      <button
                        onClick={() => handleEdit(post)}
                        className="flex items-center gap-1 text-blue-600 font-medium hover:text-blue-800 transition"
                      >
                        <CiEdit className="text-xl" /> Edit
                      </button>
                      <button
                        onClick={() => handleDelete(post._id)}
                        className="flex items-center gap-1 text-red-600 font-medium hover:text-red-800 transition"
                      >
                        <RiDeleteBin2Line className="text-xl" /> Delete
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </DashboardLayout>

    </>
  );
};

export default ManagePost;

